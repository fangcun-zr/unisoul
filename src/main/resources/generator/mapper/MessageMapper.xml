<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="generator.mapper.MessageMapper">

    <resultMap id="BaseResultMap" type="generator.domain.Message">
            <id property="id" column="id" />
            <result property="sender_id" column="sender_id" />
            <result property="receiver_id" column="receiver_id" />
            <result property="content" column="content" />
            <result property="send_time" column="send_time" />
            <result property="read_status" column="read_status" />
            <result property="parent_id" column="parent_id" />
    </resultMap>


    <select id="selectThreadBaseInfo" resultType="generator.domain.MessageThread">
        SELECT
            contact_id AS contactId,
            MAX(send_time) AS lastMessageTime,  -- 确保映射到 LocalDateTime 字段
            MAX(content) AS lastMessage          -- 确保映射到 String 字段
        FROM (
                 SELECT
                     CASE
                         WHEN sender_id = #{currentUserId} THEN receiver_id
                         ELSE sender_id
                         END AS contact_id,
                     send_time,
                     content
                 FROM message
                 WHERE sender_id = #{currentUserId} OR receiver_id = #{currentUserId}
             ) tmp
        GROUP BY contact_id
        ORDER BY lastMessageTime DESC
    </select>


<!--    <select id="selectById" resultType="generator.domain.Message">-->
<!--        SELECT-->
<!--            id,-->
<!--            sender_id,-->
<!--            receiver_id,-->
<!--            content,-->
<!--            send_time,-->
<!--            read_status,-->
<!--            parent_id,-->
<!--            is_deleted-->
<!--        FROM message-->
<!--        WHERE id = #{id}-->
<!--    </select>-->

    <sql id="Base_Column_List">
        id,sender_id,receiver_id,content,send_time,read_status,
        parent_id
    </sql>
</mapper>
